<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL 常见问题总结 | ZengCP's BLOGS</title><meta name="author" content="ZengCP"><meta name="copyright" content="ZengCP"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MySQL常见问题总结面试题27：一颗B+Tree可以存放多少数据？MySQL设计者将一个B+Tree的节点的大小设置为等于一个页，InnoDB一个页的大小是16KB。 假设一个B+Tree高度2，存在一个根节点和若干个子节点，那么这颗树存放的总记录树为：根节点指针的数量*单个叶子节点记录行数*   计算根节点指针数：假设表的主键是int类型，占用的就是4个字节，指针的大小为6个字节，一个页大概可">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 常见问题总结">
<meta property="og:url" content="http://example.com/2023/11/17/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98/index.html">
<meta property="og:site_name" content="ZengCP&#39;s BLOGS">
<meta property="og:description" content="MySQL常见问题总结面试题27：一颗B+Tree可以存放多少数据？MySQL设计者将一个B+Tree的节点的大小设置为等于一个页，InnoDB一个页的大小是16KB。 假设一个B+Tree高度2，存在一个根节点和若干个子节点，那么这颗树存放的总记录树为：根节点指针的数量*单个叶子节点记录行数*   计算根节点指针数：假设表的主键是int类型，占用的就是4个字节，指针的大小为6个字节，一个页大概可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/dog.png">
<meta property="article:published_time" content="2023-11-17T12:47:38.000Z">
<meta property="article:modified_time" content="2025-03-10T17:57:32.962Z">
<meta property="article:author" content="ZengCP">
<meta property="article:tag" content="面试题">
<meta property="article:tag" content="RDS">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/dog.png"><link rel="shortcut icon" href="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/longmao.png"><link rel="canonical" href="http://example.com/2023/11/17/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL 常见问题总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-11 01:57:32'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/dog.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">86</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="ZengCP's BLOGS"><span class="site-name">ZengCP's BLOGS</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL 常见问题总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-17T12:47:38.000Z" title="发表于 2023-11-17 20:47:38">2023-11-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-10T17:57:32.962Z" title="更新于 2025-03-11 01:57:32">2025-03-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/RDS/">RDS</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/RDS/MySQL/">MySQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL 常见问题总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="MySQL常见问题总结"><a href="#MySQL常见问题总结" class="headerlink" title="MySQL常见问题总结"></a>MySQL常见问题总结</h1><h2 id="面试题27：一颗B-Tree可以存放多少数据？"><a href="#面试题27：一颗B-Tree可以存放多少数据？" class="headerlink" title="面试题27：一颗B+Tree可以存放多少数据？"></a>面试题27：一颗B+Tree可以存放多少数据？</h2><p>MySQL设计者将一个B+Tree的节点的大小设置为等于一个页，InnoDB一个页的大小是16KB。</p>
<p>假设一个B+Tree高度2，存在一个根节点和若干个子节点，那么这颗树存放的总记录树为：<strong>根节点指针的数量</strong>*<strong>单个叶子节点记录行数*</strong></p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216134727848.png" alt="image-20250216134727848"></p>
<ol>
<li>计算根节点指针数：假设表的主键是int类型，占用的就是4个字节，指针的大小为6个字节，一个页大概可以存储： 16384B &#x2F; (4B+6B) &#x3D;1638,一个节点最多可以存储1638个索引指针。 </li>
<li>计算叶子节点的能够存储的记录数：假设一行记录的数据大小1KB,那么一页就可以存储16行数据。16KB &#x2F;1KB&#x3D;16。 </li>
<li>一颗高度为2的B+Tree可以存放的记录为：<br>1638 × 16 &#x3D; 26208条数据记录，同样的方式就可以推算出高度3的B+Tree可以存放：1638 × 1638 × 16 &#x3D;42938704，可以存放4000多万条的数据。 </li>
<li>所以InnoDB中<strong>B+Tree高度一般就是1-3层</strong>，就可以满足千万级别的数据的存储，在查找数据的时候一次页的查找代表一次IO，所以通过主键索引查询通常情况只需要 1-3次IO操作就可以查到数据。</li>
</ol>
<h2 id="面试题34：说一下MySQL的SQL的查询流程"><a href="#面试题34：说一下MySQL的SQL的查询流程" class="headerlink" title="面试题34：说一下MySQL的SQL的查询流程"></a>面试题34：说一下MySQL的SQL的查询流程</h2><p>MySQL的查询过程：</p>
<p>1）通过客户端&#x2F;服务器通信协议，与MySQL建立连接</p>
<ol>
<li>查询缓存（默认是关闭的），如果开启，就先从缓存中获取，获取直接返回，没有获取到的话，继续向下走 进行语法解析。</li>
</ol>
<p>3）预处理器生产一颗解析树。</p>
<p>4）查询优化器生产执行计划。</p>
<p>5）查询执行引擎执行SQL语句，与存储引擎交互返回结果。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216134847311.png" alt="image-20250216134847311"></p>
<h2 id="面试题60：介绍一下数据的设计范式？"><a href="#面试题60：介绍一下数据的设计范式？" class="headerlink" title="面试题60：介绍一下数据的设计范式？"></a>面试题60：介绍一下数据的设计范式？</h2><p>概念：三范式就是设计数据库的原则。</p>
<ul>
<li>第一范式：表字段列原子性，做到列的不可拆分的。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216140534239.png" alt="image-20250216140534239"></p>
<ul>
<li>第二范式：一张表只能描述一件事情。目的是让表中的每个列都与主键有关。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216140539654.png" alt="image-20250216140539654"></p>
<ul>
<li>第三范式：消除传递依赖，表的信息，如果能够被推导出来，就不应该单独的设计一个字段来进行存放。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216140544629.png" alt="image-20250216140544629"></p>
<p>数据库反三范式：</p>
<ul>
<li>反范式化指的是通过增加冗余或者重复的数据来提高数据库的读性能。</li>
<li>浪费存储的空间，节省查询时间。（以空间区换时间）</li>
</ul>
<p>什么是冗余字段？</p>
<ul>
<li>设置数据库时，某一个字段在多张表中出现了，并且完全等同于它在其他表中的表示的含义，这个字段就是冗余字段。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216140551842.png" alt="image-20250216140551842"></p>
<p>使用场景：</p>
<ul>
<li>当需要查询订单表所有数据并且只需要用户姓名信息时，如果没有冗余字段，通过JOIN进行表连接查询，加入数据量比较大，本次的连接查询就会带来很大性能消耗。<br>这时如果有冗余字段，就只需要查询一张表。</li>
</ul>
<p>总结一下：</p>
<ul>
<li>尽量遵循范式理论的约束，尽可能减少冗余字段，让数据库的设计更加的合理。</li>
<li>可以合理的加入冗余字段，减少不必要的表连接查询，让数据库的执行性能更快。</li>
</ul>
<h2 id="面试题62：InnoDB行锁如何进行优化？"><a href="#面试题62：InnoDB行锁如何进行优化？" class="headerlink" title="面试题62：InnoDB行锁如何进行优化？"></a>面试题62：InnoDB行锁如何进行优化？</h2><p>合理运用Innodb行级锁，应该做好以下几点：</p>
<ol>
<li>尽可能的让所有的数据检索都通过索引完成，避免Innodb因为无法对索引键加锁，导致升级为行级锁的问题。</li>
<li>合理的设计索引，让Innodb在索引键加锁的时候 准确度更高，锁定的范围更小，避免因为锁定导致影响其他的查询操作。</li>
<li>尽可能的减少基于范围的数据检索，避免因为间隙锁带来的负面影响，锁定了一些不应该锁定的记录。</li>
<li>尽可能的控制事务的大小，减少锁定的资源量和锁定的时间长度。</li>
<li>在业务允许的情况下，尽量选择使用较低的事务隔离界别，减少MySQL因为实现事务隔离级别所带来的附加成本。</li>
</ol>
<p>查询系统中行锁的使用情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;%innodb_row_lock%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_current_waits <span class="operator">|</span> <span class="number">0</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time          <span class="operator">|</span> <span class="number">156227</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_avg      <span class="operator">|</span> <span class="number">39056</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_max      <span class="operator">|</span> <span class="number">51081</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_waits         <span class="operator">|</span> <span class="number">4</span>      <span class="operator">|</span></span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216140603714.png" alt="image-20250216140603714"></p>
<h2 id="面试题63：说一下乐观锁的实现方式？"><a href="#面试题63：说一下乐观锁的实现方式？" class="headerlink" title="面试题63：说一下乐观锁的实现方式？"></a>面试题63：说一下乐观锁的实现方式？</h2><p>实现乐观锁的步骤，主要有两步：</p>
<ol>
<li>冲突检测</li>
<li>数据更新</li>
</ol>
<p>CAS实现乐观锁：当多个线程尝试使用CAS同时更新一个变量时，只有其中一个线程能够完成变量值的更新，其他线程都失败了，失败之后线程也不会被挂起，而是会采用重试。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 扣减库存</span></span><br><span class="line"><span class="comment">-- 首先查询商品的库存，kucun = 3</span></span><br><span class="line"><span class="keyword">select</span> kucun <span class="keyword">from</span> products <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 修改商品的库存</span></span><br><span class="line"><span class="keyword">update</span> products <span class="keyword">set</span> kucun <span class="operator">=</span> <span class="number">2</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> kucun <span class="operator">=</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>CAS乐观锁机制能够提升吞吐量，并且保证一致性，但是在极端情况下可能会出现ABA问题。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135303836.png" alt="image-20250216135303836"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.并发线程1：获取出数据的初始值3，后续计划实施CAS乐观锁，期望数据仍然还是3，只有是3的时候，修改才能成功。</span><br><span class="line">2.并发线程2：将数据修改成2</span><br><span class="line">3.并发线程3：将数据修改回3</span><br><span class="line">这个个时候就出现了ABA问题</span><br></pre></td></tr></table></figure>

<p>解决ABA问题的方式：</p>
<ul>
<li>设计一个单独的可以顺序递增的version字段，每操作一次，将该字段的值 + 1，version字段用来查看被读记录有没有变化的，作用是防止记录在业务处理期间被其他的事务修改。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.查询出商品sql,version =1</span></span><br><span class="line"><span class="keyword">select</span> kucun，version <span class="keyword">from</span> products <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 2. 根据商品生成订单</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders......</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> items...</span><br><span class="line"><span class="comment">-- 3. 修改商品的库存，同时增加版本字段的值+1</span></span><br><span class="line"><span class="keyword">update</span> products <span class="keyword">set</span> kucun<span class="operator">=</span> kucun <span class="operator">-</span> <span class="number">1</span>,version <span class="operator">=</span> version <span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> version <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<h2 id="面试题64：count-列名-、count-1-和-count-有什么区别"><a href="#面试题64：count-列名-、count-1-和-count-有什么区别" class="headerlink" title="面试题64：count(列名)、count(1)和 count(*)有什么区别?"></a>面试题64：count(列名)、count(1)和 count(*)有什么区别?</h2><p>进行统计操作时，count中的统计条件可以有三种选择：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from user;</span><br><span class="line">select count(1) from user;</span><br><span class="line">select count(列名) from user;</span><br></pre></td></tr></table></figure>

<p>执行效果上：</p>
<ul>
<li>count(*) 包括了所有的列，在统计的时候不会忽略列值为null的数据。</li>
<li>count(1) 用1表示代码行，在统计时不会忽略列值为null的数据。</li>
<li>count(列名) 在统计时，会忽略值为null的数据，就是说某个字段的值为null时就不统计。</li>
</ul>
<p>执行效率上看：</p>
<ul>
<li><p>Innodb存储引擎：count(字段)  &lt; count(1) &#x3D; count(*) </p>
</li>
<li><p>Innodb通过遍历最小的可用的二级索引来处理select count(*)语句，如果二级索引不存在，则通过扫描聚簇索引来处理。</p>
</li>
<li><p>Innodb是以同样的方式区处理count(1)和count(*).</p>
</li>
<li><p>MyISAN存储引擎：count(字段)  &lt; count(1) &lt;&#x3D; count(*) </p>
</li>
<li><p>MyISAM存储量数据的准确的行数，使用count(*) 会直接返回总行数。优先选择count(**), 其次选择count(1)</p>
</li>
<li><p>count(列名) 会遍历整个表，但是不同的是，会先获取列，然后判断是否为空，然后再累加，因此count(列名) 不如前两者。</p>
</li>
</ul>
<h2 id="面试题65：说一下MySQL主从复制的作用及原理？"><a href="#面试题65：说一下MySQL主从复制的作用及原理？" class="headerlink" title="面试题65：说一下MySQL主从复制的作用及原理？"></a>面试题65：说一下MySQL主从复制的作用及原理？</h2><p>主从复制的用途：</p>
<ul>
<li>实时灾备，用于故障切换。</li>
<li>读写分离，提供查询服务。提高查询效率。</li>
<li>备份，避免影响业务。</li>
</ul>
<p>主从复制的必要条件：</p>
<ul>
<li>主库开启binlog日志。</li>
<li>主从server-id不能相同。</li>
<li>从库服务器能够联通主库。</li>
</ul>
<p>主从复制的原理：</p>
<ul>
<li>主从复制的实现是依赖于MySQL中binlog日志，该日志中记录了所有修改数据库的SQL语句（DML ，create drop…）。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135309733.png" alt="image-20250216135309733"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.主库有更新时间，就要记录到binlog。</span><br><span class="line">2.主库创建一个线程 binlog dump thread，把binlog内容发送到从库</span><br><span class="line">3.从库启动发起连接，连接到主库</span><br><span class="line">4.从库启动，创建一个IO线程，读取主库传过来的binlog内容，写入 relay log中。</span><br><span class="line">5.从库启动，创建一个SQL线程，从relay log中读取内容，执行读取到的更新时间，将更新的内容写入到从库。</span><br></pre></td></tr></table></figure>

<h2 id="面试题66：如何进行分页查询优化？"><a href="#面试题66：如何进行分页查询优化？" class="headerlink" title="面试题66：如何进行分页查询优化？"></a>面试题66：如何进行分页查询优化？</h2><p>一般的分页查询使用limit关键来实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from 表明 limit [offset,] rows;</span><br><span class="line">第一个参数：指定第一个返回记录行偏移量，注意是从 0 开始。</span><br><span class="line">第二个参数：指定返回记录行的最大数目。</span><br><span class="line">如果只给定了一个参数，他表示返回最大记录行数目</span><br></pre></td></tr></table></figure>

<p>情况1：如果偏移量是固定，返回的记录数是变化的，返回的记录数不断增加，对执行的效率有什么影响吗？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from user limit 1000,1;</span><br><span class="line">select * from user limit 1000,10;</span><br><span class="line">select * from user limit 1000,100;</span><br><span class="line">select * from user limit 1000,1000;</span><br></pre></td></tr></table></figure>

<p>结论：在查询记录时，返回的记录量低于100条，查询的时间是基本没有变化的。但是随着查询的记录量越大，所花费的时间也就越多。</p>
<p>情况2：如果查询偏移量变化，返回的记录数固定，对执行时间有什么影响呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from user limit 1,1000;</span><br><span class="line">select * from user limit 100,1000;</span><br><span class="line">select * from user limit 1000,1000;</span><br><span class="line">select * from user limit 10000,1000;</span><br></pre></td></tr></table></figure>

<p>结论：在查询记录时，如果查询记录量相同，偏移量是不断变化的，那么超过100以后随着偏移量的不断的增加，查询的时间就会急剧增加。</p>
<p>优化方式1：通过索引进行分页</p>
<ul>
<li>直接进行limit操作，会产生全表扫描，速度会很慢，limit限制是从结果集M位置处取出N条数据，其他抛弃。 </li>
<li>假设id是连续递增，我们可以根据查询的页数和查询的记录数算出要查询的id的范围，然后配合limit使用。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where id &gt;= 1001 limit 100;</span><br></pre></td></tr></table></figure>

<p>优化方式2：利用子查询优化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 首先定位偏移位置的ID</span><br><span class="line">select id from user where limit 10000,1;</span><br><span class="line"></span><br><span class="line">-- 根据获取到的ID向后查询</span><br><span class="line">select * from user where id &gt;= (select id from user where limit 10000,1) limit 1000;</span><br></pre></td></tr></table></figure>

<h2 id="面试题67：MySQL中都有哪几种加锁范围？"><a href="#面试题67：MySQL中都有哪几种加锁范围？" class="headerlink" title="面试题67：MySQL中都有哪几种加锁范围？"></a>面试题67：MySQL中都有哪几种加锁范围？</h2><p>MySQL中按照加锁范围分类，大致有三种：</p>
<ul>
<li>全局锁</li>
<li>表级锁</li>
<li>行级锁</li>
</ul>
<p>全局锁</p>
<ul>
<li><p>什么是全局锁，是对整个的数据库实例加锁，添加全局锁之后以下的一些语句会被阻塞 </p>
</li>
<li><p>数据更新（DML）</p>
</li>
<li><p>数据定义语句</p>
</li>
<li><p>更新类事务无法提交</p>
</li>
<li><p>全局锁的典型的应用场景：做全库的逻辑备份，重新做主从的时候。 </p>
</li>
<li><p>全局锁的使用方式</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 第一种方式 推荐使用</span></span><br><span class="line">flush tables <span class="keyword">with</span> read lock;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二种方式 不建议使用</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> readonly <span class="operator">=</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>全局锁的使用</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> flush tables <span class="keyword">with</span> read lock;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> A    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> B    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> C    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test1 <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;D&#x27;</span>);</span><br><span class="line">ERROR <span class="number">1223</span> (HY000): Can<span class="string">&#x27;t execute the query because you have a conflicting read lock</span></span><br><span class="line"><span class="string">mysql&gt; unlock tables;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; insert into test1 values(4,&#x27;</span>D<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">Query OK, 1 row affected (0.01 sec)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>表级锁 </p>
</li>
<li><p>是MySQL中锁定粒度最大的一种锁，表示是对当前操作的表加锁。</p>
</li>
<li><p>表级锁分为：共享锁，排他锁。</p>
</li>
<li><p>MyISAM引擎的表级锁使用</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> mylock01(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     title <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> )engine myisam;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> mylock02(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     title <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> )engine myisam;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> mylock01(title) <span class="keyword">values</span>(<span class="string">&#x27;a1&#x27;</span>),(<span class="string">&#x27;b1&#x27;</span>),(<span class="string">&#x27;c1&#x27;</span>),(<span class="string">&#x27;d1&#x27;</span>),(<span class="string">&#x27;e1&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> mylock02(title) <span class="keyword">values</span>(<span class="string">&#x27;a2&#x27;</span>),(<span class="string">&#x27;b2&#x27;</span>),(<span class="string">&#x27;c2&#x27;</span>),(<span class="string">&#x27;d2&#x27;</span>),(<span class="string">&#x27;e2&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock01;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> title <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> a1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> b1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> c1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> d1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> e1    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock02;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> title <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> a2    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> b2    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> c2    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> d2    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> e2    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>加锁语法</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">open</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Table</span>    <span class="operator">|</span> In_use <span class="operator">|</span> Name_locked <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> mylock01 <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> test1    <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> mylock02 <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">open</span> tables <span class="keyword">where</span> In_use <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>手动加锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 加锁语法</span></span><br><span class="line">lock <span class="keyword">table</span> 表名 read(write),表明<span class="number">2</span> read(write);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> lock <span class="keyword">table</span> mylock01 read,mylock02 write;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">open</span> tables <span class="keyword">where</span> In_use <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Table</span>    <span class="operator">|</span> In_use <span class="operator">|</span> Name_locked <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> mylock01 <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> mylock02 <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>测试读锁 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> lock <span class="keyword">table</span> mylock01 read,mylock02 write;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">open</span> tables <span class="keyword">where</span> In_use <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Table</span>    <span class="operator">|</span> In_use <span class="operator">|</span> Name_locked <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> mylock01 <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> testdb   <span class="operator">|</span> mylock02 <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>           <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+--------+-------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock01;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> title <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> a1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> b1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> c1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> d1    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> e1    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新报错，因为表已经被锁定，无法进行更新操作</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mylock01 <span class="keyword">set</span> title <span class="operator">=</span> <span class="string">&#x27;a123&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">ERROR <span class="number">1099</span> (HY000): <span class="keyword">Table</span> <span class="string">&#x27;mylock01&#x27;</span> was locked <span class="keyword">with</span> a READ lock <span class="keyword">and</span> can<span class="string">&#x27;t be updated</span></span><br><span class="line"><span class="string">mysql&gt; select * from mylock02;</span></span><br><span class="line"><span class="string">+----+-------+</span></span><br><span class="line"><span class="string">| id | title |</span></span><br><span class="line"><span class="string">+----+-------+</span></span><br><span class="line"><span class="string">|  1 | a2    |</span></span><br><span class="line"><span class="string">|  2 | b2    |</span></span><br><span class="line"><span class="string">|  3 | c2    |</span></span><br><span class="line"><span class="string">|  4 | d2    |</span></span><br><span class="line"><span class="string">|  5 | e2    |</span></span><br><span class="line"><span class="string">+----+-------+</span></span><br><span class="line"><span class="string">5 rows in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 窗口2</span></span><br><span class="line"><span class="string">mysql&gt; select * from mylock01;</span></span><br><span class="line"><span class="string">+----+-------+</span></span><br><span class="line"><span class="string">| id | title |</span></span><br><span class="line"><span class="string">+----+-------+</span></span><br><span class="line"><span class="string">|  1 | a1    |</span></span><br><span class="line"><span class="string">|  2 | b1    |</span></span><br><span class="line"><span class="string">|  3 | c1    |</span></span><br><span class="line"><span class="string">|  4 | d1    |</span></span><br><span class="line"><span class="string">|  5 | e1    |</span></span><br><span class="line"><span class="string">+----+-------+</span></span><br><span class="line"><span class="string">5 rows in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; update mylock01 set title = &#x27;</span>a123<span class="string">&#x27; where id = 1;</span></span><br><span class="line"><span class="string">-- 阻塞，因为窗口1中已经将该表锁定了，需等带窗口1释放锁。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 窗口1释放锁</span></span><br><span class="line"><span class="string">mysql&gt; unlock tables;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 窗口2 整常执行了</span></span><br><span class="line"><span class="string">mysql&gt; update mylock01 set title = &#x27;</span>a123<span class="string">&#x27; where id = 1;</span></span><br><span class="line"><span class="string">Query OK, 1 row affected (44.67 sec)</span></span><br><span class="line"><span class="string">Rows matched: 1  Changed: 1  Warnings: 0</span></span><br></pre></td></tr></table></figure>

<p>总结： 对于MyISAM引擎表，加读锁，不会阻塞其他进程 对一表进行读取操作的，但是会阻塞对同一表的写请求，只有读锁释放之后，才会执行其他进程的写操作。<br>加写锁测试 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> lock <span class="keyword">table</span> mylock01 write;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock01 <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> title <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> a123  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mylock01 <span class="keyword">set</span> title <span class="operator">=</span> <span class="string">&#x27;a123&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">1</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock02;</span><br><span class="line">ERROR <span class="number">1100</span> (HY000): <span class="keyword">Table</span> <span class="string">&#x27;mylock02&#x27;</span> was <span class="keyword">not</span> locked <span class="keyword">with</span> LOCK TABLES</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口2</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mylock01; </span><br><span class="line"><span class="comment">-- 阻塞</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mylock01 <span class="keyword">set</span> title <span class="operator">=</span> <span class="string">&#x27;a456&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 阻塞</span></span><br></pre></td></tr></table></figure>

<p>总结：MyISAM表加写锁，会阻塞其他进程对同一表的读和写操作，只有写锁释放之后，才能执行其他进程的操作。注意：加写锁之后，当前进程页不被允许访问其他表。<br>行级锁测试<br>Innodb行锁的类型： </p>
<ul>
<li>共享锁（S）</li>
<li>排他锁（X）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> innodb_lock <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;aaa&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">1</span>  Changed: <span class="number">1</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> innodb_lock;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> aaa  <span class="operator">|</span>   <span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> a    <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> a    <span class="operator">|</span>   <span class="number">33</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> a    <span class="operator">|</span>   <span class="number">43</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> a    <span class="operator">|</span>   <span class="number">43</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> b    <span class="operator">|</span>   <span class="number">53</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">7</span> <span class="operator">|</span> a    <span class="operator">|</span>   <span class="number">63</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> d    <span class="operator">|</span>   <span class="number">73</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>总结：在有写锁的情况下，一个事务时不允许读取到其他事务没有提交的内容的。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> innodb_lock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> aaa  <span class="operator">|</span>   <span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口2</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> ionodb_lock <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;bbb&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> innodb_lock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> bbb  <span class="operator">|</span>   <span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> innodb_lock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> aaa  <span class="operator">|</span>   <span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>总结一下：在有写锁的情况下，一个事务内多次读取同一数据的结果，始终与第一次读取的结果保持一致。 </p>
<h2 id="面试题68：说一下行级锁的分类？"><a href="#面试题68：说一下行级锁的分类？" class="headerlink" title="面试题68：说一下行级锁的分类？"></a>面试题68：说一下行级锁的分类？</h2><p>回顾行级锁:</p>
<ul>
<li>Innodb存储引擎支持行级锁，MyISAM是不支持的。 </li>
<li>普通的select语句不会对记录加锁，因为它是快照读。 </li>
<li>如果要在查询时对记录加行锁，可以使用下面两种方式</li>
</ul>
<p>上面两条语句必须在一个事务中，因为事务提交时，锁就会被释放。 </p>
<p>行级锁的类型主要有三类：</p>
<ul>
<li>record lock：记录锁，指的是将一条记录加锁，锁上。</li>
<li>gap lock： 间隙锁，锁定的是一个范围，但是不包含记录本身。</li>
<li>next-key lock: 记录锁 + 间隙锁的组合，锁定一个范围，并且锁定记录本身。</li>
</ul>
<p>record lock：记录锁，锁住的是一条记录，记录锁是有共享锁和排他锁的区别。</p>
<ul>
<li>当一个事务对一条记录加了S锁之后，其他的事务也可以继续对该记录追加S型记录锁（S锁和S锁之间是兼容），但是不能加X型的记录锁。 </li>
<li>当一个事务对一条记录加了X锁之后，其他的事务不能添加S锁，也不能追加X锁。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>；</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p> gap lock: 间隙锁，只存在于RR隔离级别目的就是为了解决可重复读隔离级别下幻读的问题。</p>
<ul>
<li>假设，表中有一个范围是（3,5）间隙锁，其他事务就无法插入id&#x3D;4这条记录，这样就防止了幻读的发生。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135320492.png" alt="image-20250216135320492"></p>
<p>next-key-lock: 临键锁，记录锁+间隙锁的组合。</p>
<ul>
<li>假设，表中有一个范围ID为（3,5] 临键锁，其他事务不能插入ID&#x3D;4 的记录，也不能修改ID&#x3D;5的记录</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135326776.png" alt="image-20250216135326776"></p>
<ul>
<li>临键锁，既能保护记录，又能阻止其他事务将新纪录插入到被保护的记录前面的间隙。</li>
</ul>
<p>插入意向锁简介：</p>
<p>当一条记录，正在被某个事务操作时，其他事务就会进入阻塞状态，直到拥有间隙锁的事务提交位置，在此期间会生产一个插入意向锁，表明有事务想在某个区间插入新的记录， 现在正处在等待状态。</p>
<h2 id="面试题69：为什么说-插入、更新、删除操作，都归为当前读？"><a href="#面试题69：为什么说-插入、更新、删除操作，都归为当前读？" class="headerlink" title="面试题69：为什么说 插入、更新、删除操作，都归为当前读？"></a>面试题69：为什么说 插入、更新、删除操作，都归为当前读？</h2><p>MVCC多版本并发控制的机制中，读操作被分为两类：</p>
<p>快照读：简单的select操作时不加锁，属于快照读。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span></span><br></pre></td></tr></table></figure>

<p>当前读: 特殊的读操作，插入、更新、删除操作，都属于当前读，需要加锁。</p>
<p>当前读 读取的是最新的版本记录。并且，在读取之后，还需要保证其他并发事务不会修改当前的记录，对读取的记录加锁的，除了in share mode对读取的记录加的是共享锁意外，其他操作加的都是X锁 排他锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ...</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">table</span> ...</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> ...</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">in</span> share mode;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>update操作的流程：</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135332101.png" alt="image-20250216135332101"></p>
<ol>
<li>当更新语句发送给MySQL后，MySQL Server会根据where条件， 读取第一个满足条件的记录，InnoDB引擎会将查询到的第一条记录返回，并加上锁(current read当前读)。</li>
<li>MySQL Server收到这条加锁的记录后，会再发起一个Update请求，更新这条记录。</li>
<li>一条记录操作完成，再读取下一条记录，直到没有满足条件的记录为止。</li>
</ol>
<p>总结：通过上面的分析，我们可以知道Update操作内部，就包含了一个当前读。同理，Delete操作也一样。Insert操作有时可能会触发Unique Key 冲突检查，也会有一个当前读，读取这个主键是否已经存在。</p>
<h2 id="面试题70：说一下MySQL中对于不同的隔离级别和索引类型，行锁采用的加锁方式有什么不同？"><a href="#面试题70：说一下MySQL中对于不同的隔离级别和索引类型，行锁采用的加锁方式有什么不同？" class="headerlink" title="面试题70：说一下MySQL中对于不同的隔离级别和索引类型，行锁采用的加锁方式有什么不同？"></a>面试题70：说一下MySQL中对于不同的隔离级别和索引类型，行锁采用的加锁方式有什么不同？</h2><p>问： 下面的查询语句加锁了吗？加的是什么类型的锁？</p>
<p><strong>SQL1：select * from v1 where id &#x3D; 1;</strong></p>
<p>在串行化隔离级别下，是加了读锁。其余三种隔离级别，由于MVCC快照读，所以是不加锁</p>
<p>问： 下面的查询语句加锁了吗？加的是什么类型的锁？</p>
<p><strong>SQL1：delete from v1 where id &#x3D; 10;</strong></p>
<p>分析SQL语句的加锁情况时，应该注意以下几个问题：</p>
<ol>
<li>id 列是不是主键？ </li>
<li>当前系统的隔离级别是什么？ </li>
<li>id列如果不是主键，那么id列上有没有索引？ </li>
<li>id列上如果有索引，这个索引是不是唯一索引。 </li>
<li>SQL的执行计划是什么？索引扫描、全表扫描。</li>
</ol>
<p><strong>RC隔离级别加锁机制</strong></p>
<p>组合一：id主键 + RC级别。当id是主键时，只需要在该条SQL操作的数据记录上加写锁即可。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135338217.png" alt="image-20250216135338217"></p>
<p>组合二：id唯一索引 + RC级别。</p>
<p>因为id是唯一索引，where会走id列的索引进行过滤，在找到id&#x3D;10的记录后对唯一索引id&#x3D;10的记录加X锁。</p>
<p>同时会回表查询主键索引name&#x3D;d的数据，并对name&#x3D;d的数据也加上X锁。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135343620.png" alt="image-20250216135343620"></p>
<p>唯一索引与主键索引都需要加锁，因为如果在执行这条删除语句的时候，并发出现了一条更新语句，更新语句的where条件是name字段， 那么如果删除操作没有对主键索引加锁，那么更新语句不会知道有删除操作的存在从而进行更新，这样就违反了同一数据行上的写操作需要串行化执行的原则。</p>
<p>组合三：id非唯一索引 + RC级别。</p>
<p>1）对ID索引中符合条件的数据加上X锁。</p>
<p>2）再把对应的主键索引上的数据也加上X锁。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135348146.png" alt="image-20250216135348146"></p>
<p>与组合二的区别在于ID是非唯一索引的情况下，会对满足条件的多条数据都加上X锁。而组合二因为id是唯一索引列，所以只会对一条数据加上X锁。</p>
<p>组合四：id无索引 + RC级别。</p>
<p>由于没有索引，所以走的是全表扫描，所以会对主键索引上每一条记录施加X锁。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135352528.png" alt="image-20250216135352528"></p>
<p><strong>RR隔离级别加锁机制</strong></p>
<p>​	id主键+RR隔离级别 与 组合一一致。</p>
<p>​	id唯一索引 + RR隔离级别，与组合二一致。</p>
<p>组合五：id非唯一索引+RR：</p>
<p>RC 级别下允许幻读的出现。</p>
<p>RR级别不允许幻读的出现，InnoDB通过增加间隙锁来解决这个问题。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135358589.png" alt="image-20250216135358589"></p>
<p>1）首先对ID索引中符合条件的数据施加X锁。</p>
<p>2）对符合条件施加X锁的数据前后间隙施加间隙锁。</p>
<p>3）对ID索引对应的主键索引的数据施加X锁。</p>
<p>施加了GAP锁以后，数据的前后都不会插入新的数据，就可以保证两次当前读的结果完全一致。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135404703.png" alt="image-20250216135404703"></p>
<p>在Repeatable Read隔离级别下，如果进行全表扫描的当前读，那么会锁上表中的所有记录，同时会锁上聚簇索引内的所有GAP，杜绝所有的并发 更新&#x2F;删除&#x2F;插入 操作。当然，也可以通过触发semi-consistent read，来缓解加锁开销与并发影响，但是semi-consistent read本身也会带来其他问题，不建议使用。</p>
<h2 id="面试题71：MySQL何时需要进行分库分表？"><a href="#面试题71：MySQL何时需要进行分库分表？" class="headerlink" title="面试题71：MySQL何时需要进行分库分表？"></a>面试题71：MySQL何时需要进行分库分表？</h2><p>什么情况下需要用到分库分表：</p>
<ul>
<li>单机存储容量达到瓶颈。</li>
<li>服务器连接数和处理能里能力达到上限。</li>
<li>单表数据量超过1000万条或者达到100G时候，可以考虑分库分表。</li>
</ul>
<p>分库分表的方式：</p>
<ul>
<li><strong>垂直分库：</strong><br>按照业务不同，将不同的表进行分类，相同业务下的表放到一个数据库上。<br>将数据库部署到不同的服务器上，减轻单台服务器负载压力。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135410477.png" alt="image-20250216135410477"></p>
<ul>
<li><strong>垂直分表：</strong></li>
</ul>
<p>表中的字段太多，包含大字段的时候，在查询时对数据库IO、内存来说压力是比较大的，在数据更新时，会产生大量binlog日志，MySQL在进行主从同步时有延时风险。</p>
<p>垂直分表指的是将一个表，按照字段进行拆分，拆分成多个表。</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135415571.png" alt="image-20250216135415571"></p>
<ul>
<li><strong>垂直拆分：垂直分库和垂直分表</strong><br> 解决业务层面的耦合，业务清晰。<br>可以针对不同业务的数据进行分级管理 。<br>在高并发场景下，垂直分库一定程度能够提高访问性能。<br>但是垂直拆分无法解决单表数据量多大的问题。 </li>
<li><strong>水平拆分：水平分库</strong><br>简单说： 水平分库指的是根据表中的数据的逻辑关系，将同一个表的数据按照某种条件拆分到多台数据库服务器中。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135420765.png" alt="image-20250216135420765"></p>
<ul>
<li><strong>水平拆分：水平分表</strong></li>
</ul>
<p>简单说：对于数据量比较大的一张表，按照规则把一张表的数据，拆分到多张表中，但是这些表还是在同一个数据库。 </p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135426302.png" alt="image-20250216135426302"></p>
<p><strong>垂直拆分：属于结构性的拆分，不会涉及到数据。一般是在数据库设计阶段就完成。</strong></p>
<p><strong>水平拆分：属于按照数据进行拆分。是在数据量达到一定阶段时，才会进行。</strong></p>
<h2 id="面试题72：MySQL出现死锁怎么办？"><a href="#面试题72：MySQL出现死锁怎么办？" class="headerlink" title="面试题72：MySQL出现死锁怎么办？"></a>面试题72：MySQL出现死锁怎么办？</h2><p>表级锁的死锁：</p>
<ul>
<li><p>产生原因 </p>
</li>
<li><p>用户A —》 锁定A表  —》 B表（表锁）</p>
</li>
<li><p>用户B —》锁定B表  —》A表 （表锁）</p>
</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135431638.png" alt="image-20250216135431638"></p>
<ul>
<li><p>解决方案 </p>
</li>
<li><p>上面的死锁产生的原因主要是程序的逻辑错误导致的，解决的方案就是首先要分析程序执行的逻辑，对于数据库的多表的操作时，尽量按照相同的顺序进行处理，避免同时锁定两个资源这种情况。</p>
</li>
</ul>
<p>行级锁的死锁</p>
<ul>
<li><p>产生的原因1 </p>
</li>
<li><p>如果在事务中执行了一条没有索引的SQL查询，引发全表扫描，把行级锁上升为全表锁定（等价于表锁），多个这样的事务执行后，就很容易产生死锁。</p>
</li>
<li><p>解决方案 </p>
</li>
<li><p>在SQL语句中要正确的使用索引，避免太复杂的关联查询，使用Explain执行计划对SQL进行分析，对于有全表扫描和全表锁定语句，建立相应的索引，进行优化。</p>
</li>
<li><p>产生的原因2: </p>
</li>
<li><p>两个事务分别想拿对方持有的锁，互相等待，产生死锁。</p>
</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135437985.png" alt="image-20250216135437985"></p>
<ul>
<li>产生原因3：每个事务只有一个SQL，但是有些情况还是会发生死锁。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135443931.png" alt="image-20250216135443931"></p>
<ul>
<li>解决方案：上面的原因2 和原因3，都是对索引加锁顺序的不一致导致的，所以如果可以应该尽量以相同的顺序访问索引记录和表。在程序以批量方式处理数据的时候，如果事先对数据排序，保证每个线程按固定的顺序处理记录，也可以降低出现死锁的可能。</li>
</ul>
<p>死锁案例演示：</p>
<ul>
<li>数据准备</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test_deadLock(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     name <span class="type">varchar</span>(<span class="number">50</span>),</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> age <span class="type">int</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test_deadLock <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;lisi&#x27;</span>,<span class="number">11</span>),(<span class="number">2</span>,<span class="string">&#x27;zhangsan&#x27;</span>,<span class="number">22</span>),(<span class="number">3</span>,<span class="string">&#x27;wangwu&#x27;</span>,<span class="number">33</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_deadLock;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name     <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> lisi     <span class="operator">|</span>   <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> zhangsan <span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> wangwu   <span class="operator">|</span>   <span class="number">33</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>事务和锁相关的操作</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前MySQL的事务隔离级别</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx_isolation</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx_isolation</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看加锁信息</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_locks;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前运行的所有事务</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_trx;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看锁等待的信息</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_lock_waits;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看死锁日志</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> engine innodb status;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>案例分析 </p>
</li>
<li><p>窗口1</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_deadLock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> lisi <span class="operator">|</span>   <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_id <span class="string">&#x27;事务ID&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_state <span class="string">&#x27;事务状态&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_started  <span class="string">&#x27;事务开始时间&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_weight <span class="string">&#x27;事务的权重&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_mysql_thread_id <span class="string">&#x27;事务线程ID&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_tables_locked  <span class="string">&#x27;事务拥有多少个锁&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_lock_memory_bytes <span class="string">&#x27;事务锁住的内存&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_rows_locked  <span class="string">&#x27;事务锁定的行数&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_rows_modified <span class="string">&#x27;事务修改的行数&#x27;</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span> information_schema.innodb_trx;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+---------------------+-----------------+----------------+--------------------------+-----------------------+-----------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> 事务ID   <span class="operator">|</span> 事务状态     <span class="operator">|</span> 事务开始时间        <span class="operator">|</span> 事务的权重      <span class="operator">|</span> 事务线程ID     <span class="operator">|</span> 事务拥有多少个锁         <span class="operator">|</span> 事务锁住的内存        <span class="operator">|</span> 事务锁定的行数        <span class="operator">|</span> 事务修改的行数        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+---------------------+-----------------+----------------+--------------------------+-----------------------+-----------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5023</span>     <span class="operator">|</span> <span class="keyword">RUNNING</span>      <span class="operator">|</span> <span class="number">2023</span><span class="number">-11</span><span class="number">-05</span> <span class="number">22</span>:<span class="number">38</span>:<span class="number">13</span> <span class="operator">|</span>               <span class="number">2</span> <span class="operator">|</span>             <span class="number">24</span> <span class="operator">|</span>                        <span class="number">1</span> <span class="operator">|</span>                  <span class="number">1136</span> <span class="operator">|</span>                     <span class="number">1</span> <span class="operator">|</span>                     <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+---------------------+-----------------+----------------+--------------------------+-----------------------+-----------------------+-----------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>窗口2</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test_deadLock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_id <span class="string">&#x27;事务ID&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_state <span class="string">&#x27;事务状态&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_started  <span class="string">&#x27;事务开始时间&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_weight <span class="string">&#x27;事务的权重&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_mysql_thread_id <span class="string">&#x27;事务线程ID&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_tables_locked  <span class="string">&#x27;事务拥有多少个锁&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_lock_memory_bytes <span class="string">&#x27;事务锁住的内存&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_rows_locked  <span class="string">&#x27;事务锁定的行数&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> trx_rows_modified <span class="string">&#x27;事务修改的行数&#x27;</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span> information_schema.innodb_trx;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+---------------------+-----------------+----------------+--------------------------+-----------------------+-----------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> 事务ID   <span class="operator">|</span> 事务状态     <span class="operator">|</span> 事务开始时间        <span class="operator">|</span> 事务的权重      <span class="operator">|</span> 事务线程ID     <span class="operator">|</span> 事务拥有多少个锁         <span class="operator">|</span> 事务锁住的内存        <span class="operator">|</span> 事务锁定的行数        <span class="operator">|</span> 事务修改的行数        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+---------------------+-----------------+----------------+--------------------------+-----------------------+-----------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5024</span>     <span class="operator">|</span> <span class="keyword">RUNNING</span>      <span class="operator">|</span> <span class="number">2023</span><span class="number">-11</span><span class="number">-05</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">23</span> <span class="operator">|</span>               <span class="number">3</span> <span class="operator">|</span>             <span class="number">25</span> <span class="operator">|</span>                        <span class="number">1</span> <span class="operator">|</span>                  <span class="number">1136</span> <span class="operator">|</span>                     <span class="number">1</span> <span class="operator">|</span>                     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5023</span>     <span class="operator">|</span> <span class="keyword">RUNNING</span>      <span class="operator">|</span> <span class="number">2023</span><span class="number">-11</span><span class="number">-05</span> <span class="number">22</span>:<span class="number">38</span>:<span class="number">13</span> <span class="operator">|</span>               <span class="number">2</span> <span class="operator">|</span>             <span class="number">24</span> <span class="operator">|</span>                        <span class="number">1</span> <span class="operator">|</span>                  <span class="number">1136</span> <span class="operator">|</span>                     <span class="number">1</span> <span class="operator">|</span>                     <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+---------------------+-----------------+----------------+--------------------------+-----------------------+-----------------------+-----------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>窗口1</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_deadLock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> lisi <span class="operator">|</span>   <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> test_deadLock <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;aaa&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">-- 阻塞</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看当前锁信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_id <span class="string">&#x27;锁的ID&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_trx_id <span class="string">&#x27;拥有锁的事务ID&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_mode  <span class="string">&#x27;锁的模式&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_type <span class="string">&#x27;锁的类型&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_table <span class="string">&#x27;加锁的表&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_index <span class="string">&#x27;被锁的索引&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_space <span class="string">&#x27;被锁的表空间号&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_page <span class="string">&#x27;被锁的页号&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_rec <span class="string">&#x27;被锁的记录号&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> lock_data <span class="string">&#x27;被锁的数据&#x27;</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span> information_schema.innodb_locks;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------+--------------+--------------+--------------------------+-----------------+-----------------------+-----------------+--------------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> 锁的ID      <span class="operator">|</span> 拥有锁的事务ID       <span class="operator">|</span> 锁的模式     <span class="operator">|</span> 锁的类型     <span class="operator">|</span> 加锁的表                 <span class="operator">|</span> 被锁的索引      <span class="operator">|</span> 被锁的表空间号        <span class="operator">|</span> 被锁的页号      <span class="operator">|</span> 被锁的记录号       <span class="operator">|</span> 被锁的数据      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------+--------------+--------------+--------------------------+-----------------+-----------------------+-----------------+--------------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5025</span>:<span class="number">42</span>:<span class="number">3</span>:<span class="number">4</span> <span class="operator">|</span> <span class="number">5025</span>                 <span class="operator">|</span> X            <span class="operator">|</span> RECORD       <span class="operator">|</span> `testdb`.`test_deadLock` <span class="operator">|</span> <span class="keyword">PRIMARY</span>         <span class="operator">|</span>                    <span class="number">42</span> <span class="operator">|</span>               <span class="number">3</span> <span class="operator">|</span>                  <span class="number">4</span> <span class="operator">|</span> <span class="number">3</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5024</span>:<span class="number">42</span>:<span class="number">3</span>:<span class="number">4</span> <span class="operator">|</span> <span class="number">5024</span>                 <span class="operator">|</span> X            <span class="operator">|</span> RECORD       <span class="operator">|</span> `testdb`.`test_deadLock` <span class="operator">|</span> <span class="keyword">PRIMARY</span>         <span class="operator">|</span>                    <span class="number">42</span> <span class="operator">|</span>               <span class="number">3</span> <span class="operator">|</span>                  <span class="number">4</span> <span class="operator">|</span> <span class="number">3</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------------+--------------+--------------+--------------------------+-----------------+-----------------------+-----------------+--------------------+-----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>查看锁等待的信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span>  </span><br><span class="line">	requesting_trx_id <span class="string">&#x27;请求锁的事务ID&#x27;</span>, </span><br><span class="line">	requested_lock_id <span class="string">&#x27;请求锁的锁ID&#x27;</span>, </span><br><span class="line">	blocking_trx_id <span class="string">&#x27;当前拥有锁的事务ID&#x27;</span>, </span><br><span class="line">	blocking_lock_id <span class="string">&#x27;当前拥有锁的锁ID&#x27;</span> </span><br><span class="line"><span class="keyword">from</span> information_schema.innodb_lock_waits;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+-------------------+----------------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> 请求锁的事务ID       <span class="operator">|</span> 请求锁的锁ID      <span class="operator">|</span> 当前拥有锁的事务ID         <span class="operator">|</span> 当前拥有锁的锁ID        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+-------------------+----------------------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5025</span>                 <span class="operator">|</span> <span class="number">5025</span>:<span class="number">42</span>:<span class="number">3</span>:<span class="number">4</span>       <span class="operator">|</span> <span class="number">5024</span>                       <span class="operator">|</span> <span class="number">5024</span>:<span class="number">42</span>:<span class="number">3</span>:<span class="number">4</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+-------------------+----------------------------+-------------------------+</span></span><br></pre></td></tr></table></figure>

<ul>
<li>死锁的复现</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_deadLock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> lisi <span class="operator">|</span>   <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口2</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test_deadLock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> test_deadLock <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;aaa&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">-- 阻塞</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口2 </span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test_deadLock <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>; </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec) <span class="comment">-- 删除结果是成功的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 窗口1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> test_deadLock <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;aaa&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying <span class="keyword">to</span> <span class="keyword">get</span> lock; try restarting transaction</span><br></pre></td></tr></table></figure>

<ul>
<li>死锁日志的查看</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> engine innodb status;</span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">10</span>:<span class="number">14</span> <span class="number">0x7f50b4774700</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">1</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">5060</span>, ACTIVE <span class="number">82</span> sec starting index read</span><br><span class="line"><span class="comment">-- 事务的编号，活跃的秒数，starting index read表示事务状态为根据索引读取数据</span></span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="comment">-- 表示的有一张表被使用了，locked 1 表示表上有一个表锁，对于DML语句为LOCK_IX</span></span><br><span class="line">LOCK WAIT <span class="number">3</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">2</span> <span class="type">row</span> lock(s)</span><br><span class="line">MySQL thread id <span class="number">24</span>, OS thread handle <span class="number">139984601556736</span>, query id <span class="number">479</span> localhost root updating</span><br><span class="line"><span class="keyword">update</span> test_deadLock <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;aaa&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span></span><br><span class="line"><span class="comment">-- 正在等待锁的SQL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">1</span>) WAITING <span class="keyword">FOR</span> THIS LOCK <span class="keyword">TO</span> BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">42</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index <span class="keyword">PRIMARY</span> <span class="keyword">of</span> <span class="keyword">table</span> `testdb`.`test_deadLock` trx id <span class="number">5060</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">5</span>; compact format; info bits <span class="number">32</span></span><br></pre></td></tr></table></figure>

<p>死锁的总结：</p>
<ol>
<li>对索引加锁的顺序不一致，很可能导致死锁，所以应该尽量以相同的顺序来访问索引记录和表。</li>
<li>间隙锁往往是程序中导致死锁的元凶，由于MySQL默认隔离级别是RR，会用到间隙锁，防止幻读。所以如果不可重复读和幻读对当前业务影响不大的话，可以考虑降低隔离级别为RC。</li>
<li>为表添加合理的索引，如果不走索引就会为表中的每一行数据加锁，死锁的概率增加。</li>
<li>避免大事务，尽量将大事务拆分成多个小事务来处理。</li>
<li>避免在同一时间点运行多个对同一表进行读写的脚本。</li>
<li>设置锁等待的超时参数。</li>
</ol>
<h2 id="面试题73：update-没加索引会锁全表吗？"><a href="#面试题73：update-没加索引会锁全表吗？" class="headerlink" title="面试题73：update 没加索引会锁全表吗？"></a>面试题73：update 没加索引会锁全表吗？</h2><p>update条件不加索引为什么会锁全表？</p>
<ul>
<li>Innodb存储引擎默认的隔离级别【可重复读】，在该隔离级别下可能会出现幻读的问题，因此Innodb自己实现了行锁，通过next-key-lock，来锁住记录本身以及记录之间的间隙，来防止幻读的产生。 </li>
<li>如果使用一张表中的主键或者唯一索引作为条件，那么next-key-lock就会退化成记录锁，也就是给一些行记录加锁。 </li>
<li>但是如果在update语句中where条件没有使用索引，就会产生全表扫描，就会对所有的记录加 next-key-lock(记录锁+间隙锁)，就相当于锁定了整张表。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135454533.png" alt="image-20250216135454533"></p>
<ul>
<li>在数据量非常大的数据库表执行update操作时，如果没有索引，就会给全表加上临键锁，这个锁会持续比较长的时间，直到事务结束，这期间就只能执行select语句，其他语句无法执行，业务就会停滞，影响非常大。</li>
</ul>
<p>如何避免这种问题的发生？</p>
<ul>
<li><p>设置 sql_safe_updates &#x3D;1，该参数值为1时，update语句必须满足下面的条件之一才能执行 </p>
</li>
<li><p>使用where，并且where条件中必须有索引列</p>
</li>
<li><p>使用limit</p>
</li>
<li><p>同时使用where和limit，这时where中可以没有索引。</p>
</li>
</ul>
<h2 id="面试题74：下面操作中，加了什么锁，会导致死锁吗？"><a href="#面试题74：下面操作中，加了什么锁，会导致死锁吗？" class="headerlink" title="面试题74：下面操作中，加了什么锁，会导致死锁吗？"></a>面试题74：下面操作中，加了什么锁，会导致死锁吗？</h2><p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135502690.png" alt="image-20250216135502690"></p>
<p>数据准备</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_student` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">no</span>` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `score` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_student <span class="keyword">values</span></span><br><span class="line">(<span class="number">15</span>,<span class="string">&#x27;s0001&#x27;</span>,<span class="string">&#x27;Bod&#x27;</span>,<span class="number">25</span>,<span class="number">24</span>),</span><br><span class="line">(<span class="number">18</span>,<span class="string">&#x27;s0002&#x27;</span>,<span class="string">&#x27;Alice&#x27;</span>,<span class="number">24</span>,<span class="number">77</span>),</span><br><span class="line">(<span class="number">20</span>,<span class="string">&#x27;s0003&#x27;</span>,<span class="string">&#x27;Jim&#x27;</span>,<span class="number">24</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">30</span>,<span class="string">&#x27;s0004&#x27;</span>,<span class="string">&#x27;Eric&#x27;</span>,<span class="number">23</span>,<span class="number">91</span>),</span><br><span class="line">(<span class="number">37</span>,<span class="string">&#x27;s0005&#x27;</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="number">22</span>,<span class="number">22</span>),</span><br><span class="line">(<span class="number">49</span>,<span class="string">&#x27;s0006&#x27;</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="number">25</span>,<span class="number">83</span>),</span><br><span class="line">(<span class="number">50</span>,<span class="string">&#x27;s0007&#x27;</span>,<span class="string">&#x27;Rose&#x27;</span>,<span class="number">23</span>,<span class="number">89</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+-------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> <span class="keyword">no</span>    <span class="operator">|</span> name  <span class="operator">|</span> age  <span class="operator">|</span> score <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+-------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span> s0001 <span class="operator">|</span> Bod   <span class="operator">|</span>   <span class="number">25</span> <span class="operator">|</span>    <span class="number">24</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span> <span class="operator">|</span> s0002 <span class="operator">|</span> Alice <span class="operator">|</span>   <span class="number">24</span> <span class="operator">|</span>    <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span> <span class="operator">|</span> s0003 <span class="operator">|</span> Jim   <span class="operator">|</span>   <span class="number">24</span> <span class="operator">|</span>     <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">30</span> <span class="operator">|</span> s0004 <span class="operator">|</span> Eric  <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>    <span class="number">91</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">37</span> <span class="operator">|</span> s0005 <span class="operator">|</span> Tom   <span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span>    <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">49</span> <span class="operator">|</span> s0006 <span class="operator">|</span> Tom   <span class="operator">|</span>   <span class="number">25</span> <span class="operator">|</span>    <span class="number">83</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> s0007 <span class="operator">|</span> Rose  <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>    <span class="number">89</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+-------+------+-------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>两个事务中的SQL的执行顺序：</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135508769.png" alt="image-20250216135508769"></p>
<p>事务A和事务B 都在执行insert操作后，陷入了等待状态，也就是发生了死锁，双方都在等待对方释放锁。</p>
<p>为什么会发生死锁？</p>
<ul>
<li><p>Time1阶段加锁的分析，Time阶段事务A执行下面的语句 </p>
</li>
<li><p>执行更新操作</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t_student <span class="keyword">set</span> score <span class="operator">=</span> <span class="number">100</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">0</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看锁相关信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_locks\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">139758399749528</span>:<span class="number">1065</span>:<span class="number">139758302997200</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2073</span>		<span class="comment">-- 事务A ID</span></span><br><span class="line">            THREAD_ID: <span class="number">50</span></span><br><span class="line">             EVENT_ID: <span class="number">14</span></span><br><span class="line">        OBJECT_SCHEMA: testdb</span><br><span class="line">          OBJECT_NAME: t_student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139758302997200</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span>	<span class="comment">-- 表锁</span></span><br><span class="line">            LOCK_MODE: IX		<span class="comment">-- 意向锁</span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">139758399749528</span>:<span class="number">2</span>:<span class="number">4</span>:<span class="number">5</span>:<span class="number">139758302994208</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2073</span>		<span class="comment">-- 事务A ID</span></span><br><span class="line">            THREAD_ID: <span class="number">50</span></span><br><span class="line">             EVENT_ID: <span class="number">14</span></span><br><span class="line">        OBJECT_SCHEMA: testdb</span><br><span class="line">          OBJECT_NAME: t_student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span>		</span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139758302994208</span></span><br><span class="line">            LOCK_TYPE: RECORD	<span class="comment">-- 表示行级锁</span></span><br><span class="line">            LOCK_MODE: X,GAP	<span class="comment">-- x类型间隙锁</span></span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">30</span>		<span class="comment">-- 锁范围最右值</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过查询锁信息，可以看出共加了两个锁： </p>
</li>
<li><p>表锁：X类型的意向锁</p>
</li>
<li><p>行锁：X类型的间隙锁</p>
</li>
<li><p>LOCK_TYPE中的record表示的是行级锁，不是行级锁分类下的记录锁，可以通过LOCK_MODE来来确定行级锁的类型 </p>
</li>
<li><p>LOCK_MODE &#x3D; X,GAP ，表示是间隙锁。</p>
</li>
<li><p>LOCK_MODE &#x3D; X，表示是next-key-lock临键锁。</p>
</li>
<li><p>LOCK_MODE&#x3D;X, REC_NOT_GAP ,表示是记录锁。</p>
</li>
<li><p>得出结论：此时事务A在主键索引上加的间隙锁，锁的范围是：（20，30）</p>
</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135514730.png" alt="image-20250216135514730"></p>
<ul>
<li><p>Time2阶段加锁的分析，Time2阶段事务B执行下面的语句 </p>
</li>
<li><p>执行更新操作</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t_student <span class="keyword">set</span> score <span class="operator">=</span> <span class="number">100</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">26</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">0</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看锁信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_locks\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">139758399750384</span>:<span class="number">1065</span>:<span class="number">139758303003344</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2074</span>		<span class="comment">-- 事务B的ID</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">12</span></span><br><span class="line">        OBJECT_SCHEMA: testdb</span><br><span class="line">          OBJECT_NAME: t_student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139758303003344</span></span><br><span class="line">            LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">            LOCK_MODE: IX</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               ENGINE: INNODB</span><br><span class="line">       ENGINE_LOCK_ID: <span class="number">139758399750384</span>:<span class="number">2</span>:<span class="number">4</span>:<span class="number">5</span>:<span class="number">139758303000432</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">2074</span></span><br><span class="line">            THREAD_ID: <span class="number">49</span></span><br><span class="line">             EVENT_ID: <span class="number">12</span></span><br><span class="line">        OBJECT_SCHEMA: testdb</span><br><span class="line">          OBJECT_NAME: t_student</span><br><span class="line">       PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">    SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139758303000432</span></span><br><span class="line">            LOCK_TYPE: RECORD</span><br><span class="line">            LOCK_MODE: X,GAP</span><br><span class="line">          LOCK_STATUS: GRANTED</span><br><span class="line">            LOCK_DATA: <span class="number">30</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>事务B加的锁也是X型的间隙锁，锁定的范围还是（20，30）。</p>
</li>
<li><p>事务A和事务B的间隙锁的范围是一样的，为什么不会冲突呢？原因就是 两个事务之间的间隙锁是相互兼容的，不会成产生冲突。</p>
</li>
<li><p>Time3时刻加锁分析 </p>
</li>
<li><p>事务A中执行插入操作</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t_student(id,<span class="keyword">no</span>,name,age,score) <span class="keyword">value</span>(<span class="number">25</span>,<span class="string">&#x27;soo25&#x27;</span>,<span class="string">&#x27;sony&#x27;</span>,<span class="number">28</span>,<span class="number">90</span>);</span><br><span class="line"><span class="comment">-- 阻塞</span></span><br></pre></td></tr></table></figure>

<ul>
<li>此时事务A陷入等待状态</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135520748.png" alt="image-20250216135520748"></p>
<ul>
<li><p>可以看到事务A的状态为， LOCK_STATUS: WAITING   。因为事务B生产了间隙锁,锁定的范围是（20,30）。事务A想要向该间隙插入数据，需要生成一个意向锁：LOCK_MODE: INSERT_INTENTION  ，插入意向锁。 </p>
</li>
<li><p>每插入一条新纪录，就需要看一下待插入的记录的下一条是否已经加了间隙锁，如果已经加了间隙锁，此时就会生成一个 插入意向锁，然后锁的状态设置为等待状态。 </p>
</li>
<li><p>Time4 事务B，插入一条数据</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t_student(id,<span class="keyword">no</span>,name,age,score) <span class="keyword">value</span>(<span class="number">26</span>,<span class="string">&#x27;soo25&#x27;</span>,<span class="string">&#x27;sony&#x27;</span>,<span class="number">28</span>,<span class="number">90</span>);\</span><br><span class="line"><span class="comment">-- 阻塞</span></span><br></pre></td></tr></table></figure>

<ul>
<li>事务B进入了等待状态</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135526200.png" alt="image-20250216135526200"></p>
<ul>
<li><p>事务B在生成插入意向锁时被阻塞了，是因为事务B向事务A生成的间隙锁范围（20,30）内 插入数据导致的,插入意向锁和间隙锁是冲突，所以事务B陷入等待状态。 </p>
</li>
<li><p>为什么会发生死锁？<br>在当前案例中，事务A和事务B在执行完update操作后，都持有了范围是 （20,30）的间隙锁，接下来两个事务都去执行插入操作，但是插入操作需要获取插入意向锁，所以都需要等待对方释放各自的间隙锁。于是就造成了循环等待状态，发生死锁。 </p>
</li>
<li><p>死锁总结： </p>
</li>
<li><p>两个事务即使生成的间隙锁的范围是一样的，也不会冲突。因为间隙锁目的是为了防止其他事务插入数据，因此间隙锁和间隙锁之间是兼容。</p>
</li>
<li><p>在执行插入语句的时候，如果插入的记录在其他事务持有的间隙锁的范围内，插入语句就会阻塞，因为插入语句在碰到间隙锁时，会生成一个插入意向锁，插入意向锁和间隙锁时互斥的关系。</p>
</li>
<li><p>满足死锁有四个条件：互斥、占有且等待、不可强占用、循环等待，就会发生死锁。</p>
</li>
</ul>
<h2 id="面试题75：MySQL是怎么加行锁的？"><a href="#面试题75：MySQL是怎么加行锁的？" class="headerlink" title="面试题75：MySQL是怎么加行锁的？"></a>面试题75：MySQL是怎么加行锁的？</h2><p>级锁加锁规则比较复杂，不同的场景，加锁的形式是不同的。加锁的对象是索引，加锁的基本单位是next-key lock，它是由记录锁和间隙锁组合而成的，next-key lock是前开后闭区间，而间隙锁是前开后开区间。但是，next-key lock在一些场景下会退化成记录锁或间隙锁。那到底是什么场景呢？总结一句，在能使用记录锁或者间隙锁就能避免幻读现象的场景下， next-key lock 就会退化成记录锁或间隙锁。</p>
<p>行级锁加锁的对象是索引，加锁的基本单位 next-key lock，它是由记录锁和间隙锁组合成，临键锁是前开后闭的区间，而间隙锁是前开后开的区间。</p>
<p>但是一些情况下，临键锁会退化成记录锁或者间隙锁。</p>
<p><strong>在能使用记录锁或者间隙锁的情况下就可以避免幻读问题，那么next-key-lock就会退化为记录锁或者间隙锁。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `index_age` (`age`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB  <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id,name,age) <span class="keyword">values</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> (<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="number">19</span>),</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> (<span class="number">5</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="number">21</span>),</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> (<span class="number">10</span>,<span class="string">&#x27;lucy&#x27;</span>,<span class="number">22</span>),</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> (<span class="number">15</span>,<span class="string">&#x27;kobe&#x27;</span>,<span class="number">20</span>),</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> (<span class="number">20</span>,<span class="string">&#x27;zhangsan&#x27;</span>,<span class="number">39</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name     <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> tom      <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> jack     <span class="operator">|</span>  <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span> lucy     <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span> kobe     <span class="operator">|</span>  <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span> <span class="operator">|</span> zhangsan <span class="operator">|</span>  <span class="number">39</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>1）通过主键唯一索引等值查询。</p>
<ul>
<li>查询记录是存在的，那么在索引树上定位到这一条记录后， 将该记录的索引中的next-key-lock退化成 记录锁。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> tom  <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>加锁信息查询：事务A在id&#x3D;1的记录的主键索引上加了记录锁，锁住的范围就是该条记录。 </p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135533719.png"></p>
<ul>
<li>注：由于主键具有唯一性，所以当针对主键进行等值查询时，<strong>next-key-lock会退化为记录锁</strong>。因为记录锁就可以防止幻读的出现了。 </li>
<li>查询记录不存在，在索引树中找到第一条大于该查询记录的记录后，将该记录的索引的next-key-lock退化成间隙锁。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135538977.png" alt="image-20250216135538977"></p>
<p> 当记录不存在是，事务A在id&#x3D;5的主键索引上加的是间隙锁，锁住的范围（1,5）;</p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135549903.png" alt="image-20250216135549903"></p>
<ul>
<li>select * from user where id &#x3D; 2 for update; <strong>该查询语句中的条件id&#x3D;2 是不存在的，在索引树中找到第一条大于该该记录的记录后，将该记录中next-key-lock就会退化为间隙锁。</strong></li>
</ul>
<p>2）唯一索引范围查询</p>
<ul>
<li><p>当唯一索引进行范围查询时，会对每一个扫描到的索引加 next-key锁，然后遇到下面的情况，会退化为记录锁或者间隙锁。 </p>
</li>
<li><p>情况1：针对与 大于等于 的范围查询，因为存在等值查询条件，那么等值查询的记录如果存在于表中，那么该记录的索引中的锁就会由next-key lock 退化成记录锁。 </p>
</li>
<li><p>情况2：针对于 小于或者小于等于的范围查询，要看条件值的记录是否存在于表中 </p>
</li>
<li><p>存在:<br>如果是小于条件的范围查询，扫描到终止范围查询的记录时，该记录的索引就会由next-key lock 退化为间隙锁，其他扫描的记录都是加的next-key lock 。<br>如果是小于等于条件的范围查询，扫描到终止范围查询的记录时，该记录的索引不会由next-key lock 退化为间隙锁，其他扫描的记录都是加的next-key lock 。 </p>
</li>
<li><p>不存在<br>当不存在于表中时。不管是小于还是小于等于条件范围查询，扫描到终止范围查询的记录时，该记录的索引就会有next-key lock 退化为间隙锁，其他扫描的记录都是加的next-key lock 。 </p>
</li>
<li><p>针对与大于的范围查询情况：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">15</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name     <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span> <span class="operator">|</span> zhangsan <span class="operator">|</span>  <span class="number">39</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p> <img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135555220.png" alt="image-20250216135555220"></p>
<ul>
<li><p>上面的操作加了两个X型的 临键锁。 </p>
</li>
<li><p>在id&#x3D;20这条记录上，加了范围为 （15，20] 的临键锁。</p>
</li>
<li><p>在特殊记录supremum pseudo-record  的主键上加了范围为 20，无穷大的临键锁。</p>
</li>
<li><p>针对于大于等于的范围查询分析。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">&gt;=</span> <span class="number">15</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name     <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span> kobe     <span class="operator">|</span>  <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span> <span class="operator">|</span> zhangsan <span class="operator">|</span>  <span class="number">39</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+-----+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135749448.png" alt="image-20250216135749448"></p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135742046.png" alt="image-20250216135742046"></p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135735930.png" alt="image-20250216135735930"></p>
<ul>
<li><p>针对与小于或者小于等于的范围查询 </p>
</li>
<li><p>针对与小于的范围查询时（小于等于也是一样的），查询记录不存在于表中的情况的分析：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">6</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> tom  <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> jack <span class="operator">|</span>  <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>加锁信息查看 </p>
</li>
<li><p>在id&#x3D;1这条记录的主键索引上，加了范围为（无穷小，1）的临键锁，意味着其他事务无法更新或者删除id&#x3D;1的这条记录，同时也无法插入小于1 的新记录。</p>
</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135727904.png" alt="image-20250216135727904"></p>
<ul>
<li>在id&#x3D;5这条记录的主键上，加了范围索引（1,5] 的临键锁。意味着其他事务无法更新或者删除id&#x3D;5的这条记录的，同时也无法插入id为 2 3 4的新纪录。</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135718180.png" alt="image-20250216135718180"></p>
<ul>
<li>在id&#x3D;10 这条记录的主键索引上加了间隙锁，范围是（5,10)。意味着无法插入ID值为 6 7 8 9的新纪录</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135712039.png" alt="image-20250216135712039"></p>
<hr>
<ul>
<li>针对于小于等于的范围查询，查询条件值的记录是存在于表中的。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">&lt;=</span><span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> tom  <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> jack <span class="operator">|</span>  <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>加锁信息</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135705855.png" alt="image-20250216135705855"></p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135659969.png" alt="image-20250216135659969"></p>
<p>针对于小于的范围查询，查询条件值的记录是存在于表中的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">5</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> tom  <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<ul>
<li>加锁信息</li>
</ul>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135653771.png" alt="image-20250216135653771"></p>
<p><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/image-20250216135646571.png" alt="image-20250216135646571"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">ZengCP</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/11/17/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98/">http://example.com/2023/11/17/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">ZengCP's BLOGS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a><a class="post-meta__tags" href="/tags/RDS/">RDS</a><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/dog.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/13/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/redis%20%E9%9B%86%E7%BE%A4/" title="redis 三大集群模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">redis 三大集群模式</div></div></a></div><div class="next-post pull-right"><a href="/2023/11/17/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%9F%A5%E8%AF%86%E7%82%B9%E6%A2%B3%E7%90%86--%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/" title="MySQL 知识点梳理 -- 高可用集群"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL 知识点梳理 -- 高可用集群</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/08/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%20MVCC%20%E4%BB%8B%E7%BB%8D/" title="MVCC 机制介绍"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-08</div><div class="title">MVCC 机制介绍</div></div></a></div><div><a href="/2023/11/16/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%20%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%8F%8A%E5%85%B6%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/" title="MySQL 常见问题及排查方法"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">MySQL 常见问题及排查方法</div></div></a></div><div><a href="/2023/11/03/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E8%AF%A6%E8%A7%A3/" title="MySQL 分库分表详解"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-03</div><div class="title">MySQL 分库分表详解</div></div></a></div><div><a href="/2023/11/10/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%9F%A5%E8%AF%86%E7%82%B9%E6%A2%B3%E7%90%86--%E4%BA%8B%E5%8A%A1%E5%92%8C%E9%94%81%E6%9C%BA%E5%88%B6/" title="MySQL 知识点梳理 -- 事务及锁机制"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-10</div><div class="title">MySQL 知识点梳理 -- 事务及锁机制</div></div></a></div><div><a href="/2023/11/09/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%9F%A5%E8%AF%86%E7%82%B9%E6%A2%B3%E7%90%86--%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%B1%BB/" title="MySQL 知识点梳理 -- 存储引擎相关"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">MySQL 知识点梳理 -- 存储引擎相关</div></div></a></div><div><a href="/2023/11/16/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%9F%A5%E8%AF%86%E7%82%B9%E6%A2%B3%E7%90%86--%E6%9E%B6%E6%9E%84%E4%BD%93%E7%B3%BB/" title="MySQL 知识点梳理 -- 架构体系"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">MySQL 知识点梳理 -- 架构体系</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://my-blog-images-1314066800.cos.ap-guangzhou.myqcloud.com/images/dog.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ZengCP</div><div class="author-info__description">记录心得，见证成长</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">86</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">MySQL常见问题总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9827%EF%BC%9A%E4%B8%80%E9%A2%97B-Tree%E5%8F%AF%E4%BB%A5%E5%AD%98%E6%94%BE%E5%A4%9A%E5%B0%91%E6%95%B0%E6%8D%AE%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">面试题27：一颗B+Tree可以存放多少数据？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9834%EF%BC%9A%E8%AF%B4%E4%B8%80%E4%B8%8BMySQL%E7%9A%84SQL%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">面试题34：说一下MySQL的SQL的查询流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9860%EF%BC%9A%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%8C%83%E5%BC%8F%EF%BC%9F"><span class="toc-number">1.3.</span> <span class="toc-text">面试题60：介绍一下数据的设计范式？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9862%EF%BC%9AInnoDB%E8%A1%8C%E9%94%81%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BC%98%E5%8C%96%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">面试题62：InnoDB行锁如何进行优化？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9863%EF%BC%9A%E8%AF%B4%E4%B8%80%E4%B8%8B%E4%B9%90%E8%A7%82%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%EF%BC%9F"><span class="toc-number">1.5.</span> <span class="toc-text">面试题63：说一下乐观锁的实现方式？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9864%EF%BC%9Acount-%E5%88%97%E5%90%8D-%E3%80%81count-1-%E5%92%8C-count-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB"><span class="toc-number">1.6.</span> <span class="toc-text">面试题64：count(列名)、count(1)和 count(*)有什么区别?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9865%EF%BC%9A%E8%AF%B4%E4%B8%80%E4%B8%8BMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E4%BD%9C%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86%EF%BC%9F"><span class="toc-number">1.7.</span> <span class="toc-text">面试题65：说一下MySQL主从复制的作用及原理？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9866%EF%BC%9A%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%EF%BC%9F"><span class="toc-number">1.8.</span> <span class="toc-text">面试题66：如何进行分页查询优化？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9867%EF%BC%9AMySQL%E4%B8%AD%E9%83%BD%E6%9C%89%E5%93%AA%E5%87%A0%E7%A7%8D%E5%8A%A0%E9%94%81%E8%8C%83%E5%9B%B4%EF%BC%9F"><span class="toc-number">1.9.</span> <span class="toc-text">面试题67：MySQL中都有哪几种加锁范围？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9868%EF%BC%9A%E8%AF%B4%E4%B8%80%E4%B8%8B%E8%A1%8C%E7%BA%A7%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB%EF%BC%9F"><span class="toc-number">1.10.</span> <span class="toc-text">面试题68：说一下行级锁的分类？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9869%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AF%B4-%E6%8F%92%E5%85%A5%E3%80%81%E6%9B%B4%E6%96%B0%E3%80%81%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C%EF%BC%8C%E9%83%BD%E5%BD%92%E4%B8%BA%E5%BD%93%E5%89%8D%E8%AF%BB%EF%BC%9F"><span class="toc-number">1.11.</span> <span class="toc-text">面试题69：为什么说 插入、更新、删除操作，都归为当前读？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9870%EF%BC%9A%E8%AF%B4%E4%B8%80%E4%B8%8BMySQL%E4%B8%AD%E5%AF%B9%E4%BA%8E%E4%B8%8D%E5%90%8C%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8C%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B%EF%BC%8C%E8%A1%8C%E9%94%81%E9%87%87%E7%94%A8%E7%9A%84%E5%8A%A0%E9%94%81%E6%96%B9%E5%BC%8F%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E5%90%8C%EF%BC%9F"><span class="toc-number">1.12.</span> <span class="toc-text">面试题70：说一下MySQL中对于不同的隔离级别和索引类型，行锁采用的加锁方式有什么不同？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9871%EF%BC%9AMySQL%E4%BD%95%E6%97%B6%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%EF%BC%9F"><span class="toc-number">1.13.</span> <span class="toc-text">面试题71：MySQL何时需要进行分库分表？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9872%EF%BC%9AMySQL%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.14.</span> <span class="toc-text">面试题72：MySQL出现死锁怎么办？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9873%EF%BC%9Aupdate-%E6%B2%A1%E5%8A%A0%E7%B4%A2%E5%BC%95%E4%BC%9A%E9%94%81%E5%85%A8%E8%A1%A8%E5%90%97%EF%BC%9F"><span class="toc-number">1.15.</span> <span class="toc-text">面试题73：update 没加索引会锁全表吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9874%EF%BC%9A%E4%B8%8B%E9%9D%A2%E6%93%8D%E4%BD%9C%E4%B8%AD%EF%BC%8C%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%EF%BC%8C%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81%E5%90%97%EF%BC%9F"><span class="toc-number">1.16.</span> <span class="toc-text">面试题74：下面操作中，加了什么锁，会导致死锁吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%9875%EF%BC%9AMySQL%E6%98%AF%E6%80%8E%E4%B9%88%E5%8A%A0%E8%A1%8C%E9%94%81%E7%9A%84%EF%BC%9F"><span class="toc-number">1.17.</span> <span class="toc-text">面试题75：MySQL是怎么加行锁的？</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/15/%E5%9C%BA%E6%99%AF%E9%A2%98%E6%B1%87%E6%80%BB/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E7%B1%BB/" title="系统设计类场景题">系统设计类场景题</a><time datetime="2025-02-15T10:26:53.000Z" title="发表于 2025-02-15 18:26:53">2025-02-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/15/%E5%9C%BA%E6%99%AF%E9%A2%98%E6%B1%87%E6%80%BB/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" title="面试常见场景题汇总">面试常见场景题汇总</a><time datetime="2025-02-15T07:26:53.000Z" title="发表于 2025-02-15 15:26:53">2025-02-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%20%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/" title="RocketMQ 核心架构原理">RocketMQ 核心架构原理</a><time datetime="2024-12-08T09:02:36.000Z" title="发表于 2024-12-08 17:02:36">2024-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%20%E6%A6%82%E8%BF%B0/" title="RocketMQ 概述">RocketMQ 概述</a><time datetime="2024-12-08T07:16:48.000Z" title="发表于 2024-12-08 15:16:48">2024-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/07/%E4%B8%AD%E9%97%B4%E4%BB%B6/Kafka/Kafka%20%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98/" title="Kafka 经典面试题">Kafka 经典面试题</a><time datetime="2024-12-07T12:45:18.000Z" title="发表于 2024-12-07 20:45:18">2024-12-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By ZengCP</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>